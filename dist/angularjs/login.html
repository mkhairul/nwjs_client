<!DOCTYPE html>
<!--[if lt IE 7]>  <html class="lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html>
<!--<![endif]-->

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>KCSoft - Login</title>

  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,300,500,700,900' rel='stylesheet' type='text/css'>

  <link rel="icon" type="image/png" href="../assets/_con/images/icon.png">

  <!-- nanoScroller -->
  <link rel="stylesheet" type="text/css" href="../assets/nanoScroller/nanoscroller.css" />


  <!-- FontAwesome -->
  <link rel="stylesheet" type="text/css" href="../assets/font-awesome/css/font-awesome.min.css" />

  <!-- Material Design Icons -->
  <link rel="stylesheet" type="text/css" href="../assets/material-design-icons/css/material-design-icons.min.css" />

  <!-- IonIcons -->
  <link rel="stylesheet" type="text/css" href="../assets/ionicons/css/ionicons.min.css" />

  <!-- WeatherIcons -->
  <link rel="stylesheet" type="text/css" href="../assets/weatherIcons/css/weather-icons.min.css" />
  <!-- Main -->
  <link rel="stylesheet" type="text/css" href="../assets/_con/css/_con.min.css" />
  <link rel="stylesheet" type="text/css" href="../assets/custom.css" />

  <!--[if lt IE 9]>
    <script src="../assets/html5shiv/html5shiv.min.js"></script>
  <![endif]-->
</head>

<body>

  <section id="sign-in">

    <!-- Background Bubbles -->
    <canvas id="bubble-canvas"></canvas>
    <!-- /Background Bubbles -->
    
    <div class="login-settings">
      <!-- Settings Form -->
      <form action="dashboard.html" data-parsley-validate>
        <div class="row links">
          <div class="col s6 logo">
            Settings
          </div>
          <div class="col s6 right-align"><strong>Client Setup</strong>
          </div>
        </div>
        <div class="card-panel loading" style="display:none">
          <p class="center"><i class="fa fa-spinner fa-pulse"></i> Loading</p>
        </div>

        <div class="card-panel content">
          
          <div class="alert" style="display: none;"></div>
          
          <div class="input-field">
            <i class="fa fa-user prefix"></i>
            <input id="client-name" type="text" class="validate" value="" required>
            <label for="client-name">Client Name</label>
          </div>

          <div class="input-field">
            <i class="fa fa-link prefix"></i>
            <input id="server-url" type="text" class="validate" value="" required>
            <label for="server-url">Server URL</label>
          </div>
          
          <div class="input-field">
            <i class="fa fa-key prefix"></i>
            <input id="client-key" type="text" class="validate" value="" required>
            <label for="client-key">Client Key</label>
          </div>
            
          <div class="input-field">
            <i class="fa fa-key prefix"></i>
            <input id="com-port" type="text" class="validate" value="3" required>
            <label for="com-port">COM Port</label>
          </div>

          <button type="button" id="settings-btn" class="waves-effect waves-light btn-large z-depth-0 z-depth-1-hover">Save Settings</button>
        </div>
        
        <div class="row no-margin">
          <div class="col s4 links left-align">
            <a href="#" class="show-help">
              <i class="fa fa-question-circle"></i>
              Help
            </a>
          </div>
          <div class="col s4 links right-align exit">
            <a href="#" class="show-help">
              <i class="fa fa-sign-out"></i>
              Exit
            </a>
          </div>
          <div class="col s4 links right-align">
            <a href="#" id="show-login">
              <i class="fa fa-sign-in"></i>
              Login
            </a>
          </div>
        </div>

      </form>
      <!-- /Settings Form -->  
    </div>

    <!-- Sign In Form -->
    <form action="dashboard.html" class="login-form" data-parsley-validate>
      <div class="row links">
        <div class="col s6 logo">
          KCSoft
        </div>
        <div class="col s6 right-align"><strong>Login</strong>
        </div>
      </div>
      
      <div class="card-panel loading" style="display:none">
        <p class="center"><i class="fa fa-spinner fa-pulse"></i> Loading</p>
      </div>

      <div class="card-panel content">
        
        <div class="alert" style="display: none;"></div>

        <!-- Username -->
        <div class="input-field">
          <i class="fa fa-user prefix"></i>
          <input id="username" type="text" class="validate" required>
          <label for="username">Username</label>
        </div>
        <!-- /Username -->

        <!-- Password -->
        <div class="input-field">
          <i class="fa fa-unlock-alt prefix"></i>
          <input id="password" type="password" class="validate" required>
          <label for="password">Password</label>
        </div>
        <!-- /Password -->

        <button type="button" id="login-btn" class="waves-effect waves-light btn-large z-depth-0 z-depth-1-hover">Sign In</button>
      </div>
      <div class="row no-margin">
        <div class="col s4 links left-align">
          <a href="#" class="show-help">
            <i class="fa fa-question-circle"></i>
            Help
          </a>
        </div>
        <div class="col s4 links right-align exit">
          <a href="#" class="show-help">
            <i class="fa fa-sign-out"></i>
            Exit
          </a>
        </div>
        <div class="col s4 links right-align">
          <a href="#" id="show-settings">
            <i class="fa fa-cogs"></i>
            Settings
          </a>
        </div>
      </div>

    </form>
    <!-- /Sign In Form -->

  </section>


  <!-- DEMO [REMOVE IT ON PRODUCTION] -->
  <script type="text/javascript" src="../assets/_con/js/_demo.js"></script>

  <!-- jQuery -->
  <script type="text/javascript" src="../assets/jquery/jquery.min.js"></script>

  <!-- jQuery RAF (improved animation performance) -->
  <script type="text/javascript" src="../assets/jqueryRAF/jquery.requestAnimationFrame.min.js"></script>

  <!-- nanoScroller -->
  <script type="text/javascript" src="../assets/nanoScroller/jquery.nanoscroller.min.js"></script>

  <!-- Materialize -->
  <script type="text/javascript" src="../assets/materialize/js/materialize.min.js"></script>

  <!-- Sortable -->
  <script type="text/javascript" src="../assets/sortable/Sortable.min.js"></script>
  
  <script type="text/javascript" src="../assets/parsley/parsley.min.js"></script>

  <!-- Main -->
  <script type="text/javascript" src="../assets/_con/js/_con.min.js"></script>
  <script>
    var fs = require('fs');
    var YAML = require('yamljs');
    var gui = require('nw.gui');
    var win = gui.Window.get();
  
    
    $('#login-btn').on('click', function(){
      var self = this;
      toggleLoading(self)
      console.log(settings);
      $.post(settings.server.url + '/login', { 'email': $('#username').val(), 'password': $('#password').val(), 'name': settings.client.name, 'key': settings.client.key }, function(data){
        toggleLoading(self)
        sessionStorage.username = $('#username').val();
        sessionStorage.password = $('#password').val();
        sessionStorage.name = settings.client.name;
        sessionStorage.key = settings.client.key;
        sessionStorage.url = settings.server.url;
        sessionStorage.comport = settings.comport;
        window.location = 'index.html';
      }).fail(function(){ 
        toggleLoading(self)
        $('.login-form .alert').html('Login failed').show();
        console.log('login failed'); 
      });
    });
    
    var toggleLoading = function(obj){
      console.log('Toggle Loading')
      if($(obj).closest('form').children('.loading').css('display') == 'none')
      {
        console.log('Display Loading')
        $(obj).closest('form').children('.loading').show();
        $(obj).closest('form').children('.content').hide();
      }
      else
      {
        console.log('Hide Loading')
        $(obj).closest('form').children('.loading').hide();
        $(obj).closest('form').children('.content').show();
      }
    }
    
    var loadSettings = function(){
      
      var data = '';
      try{
        data = fs.readFileSync(process.cwd() + '/settings', { encoding: 'utf8'});
      } catch (e) {
        console.log(e);
      }
      console.log(data);
      
      var settings = YAML.parse(data);
      if(settings.server.url == '' || settings.server.url == undefined){ settings = false; }
      return settings;
    }
    
    var settings = {};
    
    // Check if settings file exists.
    fs.exists(process.cwd() + '/settings', function (exists) {
      console.log(exists ? 'exists!':'not there');
      if(!exists)
      {
        $('.login-form').hide();
        $('.login-settings').show();
      }
      else
      {
        settings = loadSettings();
        console.log(settings);
        if(settings == false)
        {
          $('.login-form').hide();
          $('.login-settings').show();
        }
        else
        {
          $('.login-form').show();
          $('.login-settings').hide();
        }
      }
    });
    
    $('#show-settings').on('click', function(){
      var settings = loadSettings();
      $('.login-form').hide();
      $('.login-form .alert').hide();
      $('.login-settings').show();
      $('#client-name').val(settings.client.name).focus().blur();
      $('#client-key').val(settings.client.key).focus().blur();
      $('#server-url').val(settings.server.url).focus().blur();
      $('#com-port').val(settings.comport).focus().blur();
    });
    $('#show-login').on('click', function(){
      $('.login-form').show();
      $('.login-settings').hide();
    });
    
    $('#settings-btn').on('click', function(){
      var self = this;
      toggleLoading(self)
      $(self).closest('form').children('.alert').hide();
      
      // Check if the server url is correct / connectable
      $.get($('#server-url').val() + '/connect-test', function(data){
        console.log('url is connectable');
        var tmp_settings = {};
        tmp_settings.server = {}
        tmp_settings.server.url = $('#server-url').val();
        tmp_settings.client = {}
        tmp_settings.client.name = $('#client-name').val();
        tmp_settings.client.key = $('#client-key').val();
        tmp_settings.comport = $('#com-port').val();
        YAMLString = YAML.stringify(tmp_settings, 4);
        try{
          fs.writeFileSync(process.cwd() + '/settings', YAMLString);
          console.log('File saved');
          toggleLoading(self)
          $('.login-form').show();
          $('.login-settings').hide();
          settings = loadSettings();
        } catch (e) {
          console.log(e);
        }  
        
      }, 'json').fail(function(){
        console.log('error');
        toggleLoading(self)
        $('.alert', $(self).closest('form')).show();
        $('.alert', $(self).closest('form')).html('Invalid URL');
      });

    });
      
    $('.exit a').on('click', function(){
        win.close();
    });
    
  </script>
</body>

</html>